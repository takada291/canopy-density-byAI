<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AIæ—å† </title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="theme-color" content="#2c3e50">

    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background-color: #000; /* ã‚«ãƒ¡ãƒ©ç”»é¢ã£ã½ãé»’èƒŒæ™¯ */
            color: #fff;
            overflow: hidden; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢ */
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- ãƒ¡ã‚¤ãƒ³ç”»é¢ï¼ˆã‚«ãƒ¡ãƒ©ï¼†æ°´æº–å™¨ï¼‰ --- */
        .camera-container {
            position: relative;
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        /* ã‚«ãƒ¡ãƒ©æ˜ åƒï¼ˆãƒ“ãƒ‡ã‚ªï¼‰ */
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover; /* ç”»é¢ã„ã£ã±ã„ã«è¡¨ç¤º */
            z-index: 1;
        }

        /* æ°´æº–å™¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        .level-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border-radius: 50%;
            border: 2px dashed rgba(255, 255, 255, 0.5);
            z-index: 10;
            pointer-events: none; /* ã‚¿ãƒƒãƒæ“ä½œã‚’é€é */
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* åå­—ã‚­ãƒ¼ */
        .crosshair {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        .crosshair::before { content: ''; position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: rgba(255,255,255,0.5); }
        .crosshair::after { content: ''; position: absolute; left: 50%; top: 0; bottom: 0; width: 1px; background: rgba(255,255,255,0.5); }

        /* ä¸­å¤®ã®ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå††ï¼ˆOKåˆ¤å®šã‚¨ãƒªã‚¢ï¼‰ */
        .target-circle {
            width: 60px; /* ã•ã‚‰ã«å¤§ããã—ã¾ã—ãŸ */
            height: 60px;
            border: 3px solid rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            z-index: 11;
            transition: all 0.2s;
        }
        /* OKæ™‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        .target-circle.ok {
            border-color: #2ecc71; /* ç·‘è‰² */
            background-color: rgba(46, 204, 113, 0.3);
            box-shadow: 0 0 15px #2ecc71;
        }

        /* èµ¤ã„ç‰ï¼ˆæ°—æ³¡ï¼‰ */
        .bubble {
            position: absolute;
            width: 30px;
            height: 30px;
            background-color: #e74c3c; /* èµ¤è‰² */
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 12;
            transition: transform 0.1s linear; /* ã‚­ãƒ“ã‚­ãƒ“å‹•ã */
            box-shadow: 0 0 5px rgba(0,0,0,0.5);
        }

        /* ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ãƒœã‚¿ãƒ³ */
        .sensor-btn {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
            background: rgba(0, 0, 0, 0.6);
            color: #fff;
            border: 1px solid #fff;
            padding: 8px 16px;
            border-radius: 20px;
            display: none;
        }

        /* ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ */
        .controls-area {
            height: 120px;
            background: #222;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 20;
        }
        .shutter-btn {
            width: 70px;
            height: 70px;
            background-color: #fff;
            border-radius: 50%;
            border: 5px solid #ccc;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .shutter-btn:active {
            transform: scale(0.95);
            background-color: #ddd;
        }

        /* --- çµæœç”»é¢ï¼ˆæ’®å½±å¾Œã«è¡¨ç¤ºï¼‰ --- */
        #resultLayer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #f0f4f8;
            color: #333;
            z-index: 50;
            display: none; /* åˆæœŸã¯éè¡¨ç¤º */
            flex-direction: column;
            overflow-y: auto;
            padding-bottom: 30px;
        }
        .result-header {
            padding: 15px;
            background: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .retake-btn {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-weight: bold;
        }
        .result-content {
            padding: 20px;
            text-align: center;
        }
        .result-canvas {
            max-width: 100%;
            border: 1px solid #ccc;
            margin-bottom: 20px;
        }
        
        /* ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¨æ•°å€¤ */
        .slider-box {
            background: #fff;
            padding: 15px;
            border-radius: 10px;
            margin-top: 10px;
        }
        input[type=range] { width: 100%; margin: 15px 0; }

        .score-box {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
        }
        .main-score { font-size: 2rem; color: #27ae60; font-weight: bold; }
        .sub-score { font-size: 1rem; color: #7f8c8d; }

    </style>
</head>
<body>

<div class="camera-container">
    <video id="video" autoplay playsinline muted></video>
    
    <button id="sensorBtn" class="sensor-btn" onclick="requestSensorPermission()">ğŸ“¡ æ°´æº–å™¨ON</button>

    <div class="level-overlay">
        <div class="crosshair"></div>
        <div class="target-circle" id="targetCircle"></div>
        <div class="bubble" id="bubble"></div>
    </div>
</div>

<div class="controls-area">
    <button class="shutter-btn" id="shutterBtn"></button>
</div>

<div id="resultLayer">
    <div class="result-header">
        <h2 style="margin:0; font-size:1.2rem;">ğŸŒ² AIæ—å† ã‚¢ãƒ—ãƒª ï½–1.2</h2>
        <button class="retake-btn" onclick="resetCamera()">ğŸ“· å†æ’®å½±</button>
    </div>
    
    <div class="result-content">
        <canvas id="canvas" class="result-canvas"></canvas>
        
        <div class="slider-box">
            <label>ç©ºã®æ˜ã‚‹ã•èª¿æ•´</label>
            <input type="range" id="thresholdSlider" min="0" max="255" value="180">
            
            <div class="score-box">
                <div>
                    <div>æ—å† è¢«è¦†ç‡</div>
                    <div class="main-score" id="treeRatio">-%</div>
                </div>
                <div>
                    <div>ç©ºéš™ç‡</div>
                    <div class="sub-score" id="skyRatio">-%</div>
                </div>
            </div>
            <p style="font-size:0.8rem; color:red; margin-top:10px;">â€»èµ¤ã„éƒ¨åˆ†ã‚’ã€Œç©ºã€ã¨ã¿ãªã—ã¦ã„ã¾ã™</p>
        </div>
    </div>
</div>

<script>
    // --- ã‚µãƒ¼ãƒ“ã‚¹ãƒ¯ãƒ¼ã‚«ãƒ¼ ---
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
    }

    // --- å¤‰æ•° ---
    const video = document.getElementById('video');
    const bubble = document.getElementById('bubble');
    const targetCircle = document.getElementById('targetCircle');
    const sensorBtn = document.getElementById('sensorBtn');
    const shutterBtn = document.getElementById('shutterBtn');
    
    const resultLayer = document.getElementById('resultLayer');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const slider = document.getElementById('thresholdSlider');
    const treeRatioDisplay = document.getElementById('treeRatio');
    const skyRatioDisplay = document.getElementById('skyRatio');

    let originalImageData = null; // è§£æç”¨ãƒ‡ãƒ¼ã‚¿
    let currentStream = null;

    // --- 1. ã‚«ãƒ¡ãƒ©èµ·å‹• (WebRTC) ---
    async function startCamera() {
        try {
            const constraints = {
                video: {
                    facingMode: 'environment', // å¤–ã‚«ãƒ¡ãƒ©
                    width: { ideal: 1920 },
                    height: { ideal: 1080 }
                },
                audio: false
            };
            currentStream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = currentStream;
        } catch (err) {
            console.error("Camera Error:", err);
            alert("ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ¨©é™ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        }
    }

    // èµ·å‹•æ™‚ã«ã‚«ãƒ¡ãƒ©ON
    startCamera();

    // --- 2. æ°´æº–å™¨ãƒ­ã‚¸ãƒƒã‚¯ (iOSå¯¾å¿œ) ---
    
    // iOSã¯ãƒœã‚¿ãƒ³ã§è¨±å¯ãŒå¿…è¦
    if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
        sensorBtn.style.display = 'block';
    } else {
        window.addEventListener('deviceorientation', handleOrientation);
    }

    function requestSensorPermission() {
        DeviceOrientationEvent.requestPermission()
            .then(response => {
                if (response === 'granted') {
                    sensorBtn.style.display = 'none';
                    window.addEventListener('deviceorientation', handleOrientation);
                } else {
                    alert('ã‚»ãƒ³ã‚µãƒ¼è¨±å¯ãŒå¿…è¦ã§ã™');
                }
            })
            .catch(console.error);
    }

    function handleOrientation(event) {
        let x = event.gamma; // å·¦å³
        let y = event.beta;  // å‰å¾Œ

        // 90åº¦ä»¥ä¸Šå‚¾ã„ãŸã‚‰åˆ¶é™
        if (x > 90) x = 90; if (x < -90) x = -90;
        if (y > 90) y = 90; if (y < -90) y = -90;

        // èµ¤ç‰ã®ç§»å‹•é‡ (æ„Ÿåº¦èª¿æ•´: 1åº¦ã‚ãŸã‚Š1.5px)
        let moveX = x * 1.5;
        let moveY = y * 1.5;

        // å††ã®å¤–ã«å‡ºãªã„ã‚ˆã†ã«åˆ¶é™ (åŠå¾„80pxä»¥å†…)
        const maxDist = 80;
        const dist = Math.sqrt(moveX*moveX + moveY*moveY);
        if (dist > maxDist) {
            moveX = (moveX / dist) * maxDist;
            moveY = (moveY / dist) * maxDist;
        }

        bubble.style.transform = `translate(calc(-50% + ${moveX}px), calc(-50% + ${moveY}px))`;

        // â˜…åˆ¤å®šãƒ©ã‚¤ãƒ³ï¼šÂ±10åº¦ã¾ã§ç·©å’Œï¼ˆã“ã‚Œãªã‚‰å…¥ã‚‹ã¯ãšï¼ï¼‰
        const threshold = 10;
        if (Math.abs(x) < threshold && Math.abs(y) < threshold) {
            targetCircle.classList.add('ok'); // ç·‘è‰²ã«å…‰ã‚‹
        } else {
            targetCircle.classList.remove('ok');
        }
    }


    // --- 3. æ’®å½±ï¼†è§£æãƒ­ã‚¸ãƒƒã‚¯ ---

    shutterBtn.addEventListener('click', () => {
        // ãƒ“ãƒ‡ã‚ªã®ç¾åœ¨ã®ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã«æç”»
        const width = video.videoWidth;
        const height = video.videoHeight;
        
        // ç¸¦æ¨ªæ¯”ã‚’ç¶­æŒã—ã¦å°‘ã—å°ã•ããƒªã‚µã‚¤ã‚ºï¼ˆå‡¦ç†è»½æ¸›ï¼‰
        const MAX_SIZE = 800;
        let drawW = width;
        let drawH = height;
        if (width > height) {
            if (width > MAX_SIZE) { drawH = height * (MAX_SIZE/width); drawW = MAX_SIZE; }
        } else {
            if (height > MAX_SIZE) { drawW = width * (MAX_SIZE/height); drawH = MAX_SIZE; }
        }

        canvas.width = drawW;
        canvas.height = drawH;
        ctx.drawImage(video, 0, 0, drawW, drawH);

        // è§£æç”¨ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
        originalImageData = ctx.getImageData(0, 0, drawW, drawH);

        // çµæœç”»é¢ã‚’è¡¨ç¤º
        resultLayer.style.display = 'flex';
        
        // åˆå›è¨ˆç®—å®Ÿè¡Œ
        processImage();
    });

    // å†æ’®å½±ãƒœã‚¿ãƒ³
    function resetCamera() {
        resultLayer.style.display = 'none';
        // ã‚«ãƒ¡ãƒ©ã¯è£ã§å‹•ã„ã¦ã„ã‚‹ã®ã§ãã®ã¾ã¾
    }

    // ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼æ“ä½œ
    slider.addEventListener('input', processImage);

    // è§£æå‡¦ç†ï¼ˆã‚³ãƒ”ãƒšï¼†ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ï¼‰
    function processImage() {
        if (!originalImageData) return;

        const threshold = parseInt(slider.value);
        const w = canvas.width;
        const h = canvas.height;
        
        const src = originalImageData.data;
        const output = ctx.createImageData(w, h);
        const dst = output.data;

        let skyCount = 0;
        const totalPixels = w * h;

        for (let i = 0; i < src.length; i += 4) {
            const r = src[i];
            const g = src[i+1];
            const b = src[i+2];
            
            // è¼åº¦è¨ˆç®—
            const lum = 0.299*r + 0.587*g + 0.114*b;

            if (lum > threshold) {
                // ç©ºåˆ¤å®š -> èµ¤ãå¡—ã‚‹
                skyCount++;
                dst[i] = 255; dst[i+1] = 0; dst[i+2] = 0; dst[i+3] = 255;
            } else {
                // æœ¨åˆ¤å®š -> ãã®ã¾ã¾
                dst[i] = r; dst[i+1] = g; dst[i+2] = b; dst[i+3] = 255;
            }
        }
        
        ctx.putImageData(output, 0, 0);

        const skyRate = (skyCount / totalPixels) * 100;
        treeRatioDisplay.textContent = (100 - skyRate).toFixed(1) + '%';
        skyRatioDisplay.textContent = skyRate.toFixed(1) + '%';
    }

</script>
</body>
</html>
