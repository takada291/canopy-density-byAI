<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AIæ—å† </title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="theme-color" content="#2c3e50">

    <style>
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 0;
            background-color: #000;
            color: #fff;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* --- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ --- */
        #startScreen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: #f0f4f8;
            color: #333;
            z-index: 100;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
        }
        .app-title {
            font-size: 2rem;
            color: #2c3e50;
            margin-bottom: 40px;
            font-weight: bold;
        }
        .mode-btn {
            width: 250px;
            padding: 20px;
            margin: 10px;
            font-size: 1.2rem;
            font-weight: bold;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: transform 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        .btn-camera {
            background-color: #27ae60;
            color: white;
        }
        .btn-file {
            background-color: #3498db;
            color: white;
        }
        .mode-btn:active {
            transform: scale(0.95);
        }

        /* --- ã‚«ãƒ¡ãƒ©ç”»é¢ --- */
        .camera-container {
            position: relative;
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            background: #000;
            display: none; /* åˆæœŸã¯éè¡¨ç¤º */
        }
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
        }
        
        /* æ°´æº–å™¨ */
        .level-overlay {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 200px; height: 200px;
            border-radius: 50%;
            border: 2px dashed rgba(255, 255, 255, 0.5);
            z-index: 10;
            pointer-events: none;
            display: flex; justify-content: center; align-items: center;
        }
        .crosshair { position: absolute; width: 100%; height: 100%; }
        .crosshair::before { content: ''; position: absolute; top: 50%; left: 0; right: 0; height: 1px; background: rgba(255,255,255,0.5); }
        .crosshair::after { content: ''; position: absolute; left: 50%; top: 0; bottom: 0; width: 1px; background: rgba(255,255,255,0.5); }
        
        .target-circle {
            width: 60px; height: 60px;
            border: 3px solid rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            z-index: 11;
            transition: all 0.2s;
        }
        .target-circle.ok {
            border-color: #2ecc71;
            background-color: rgba(46, 204, 113, 0.3);
            box-shadow: 0 0 15px #2ecc71;
        }
        .bubble {
            position: absolute;
            width: 30px; height: 30px;
            background-color: #e74c3c;
            border-radius: 50%;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 12;
            transition: transform 0.1s linear;
        }

        .sensor-btn {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            z-index: 20;
            background: rgba(0, 0, 0, 0.6); color: #fff; border: 1px solid #fff;
            padding: 8px 16px; border-radius: 20px; display: none;
        }

        /* ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ã‚¨ãƒªã‚¢ */
        .controls-area {
            height: 120px;
            background: #222;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 20;
            display: none; /* åˆæœŸã¯éè¡¨ç¤º */
        }
        .shutter-btn {
            width: 70px; height: 70px;
            background-color: #fff; border-radius: 50%; border: 5px solid #ccc;
            cursor: pointer; transition: transform 0.1s;
        }
        .shutter-btn:active { transform: scale(0.95); background-color: #ddd; }
        
        /* æˆ»ã‚‹ãƒœã‚¿ãƒ³ï¼ˆã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ‰æ™‚ï¼‰ */
        .back-btn {
            position: absolute;
            bottom: 20px; left: 20px;
            color: white; font-size: 0.9rem; text-decoration: underline; cursor: pointer;
        }


        /* --- çµæœï¼†ç·¨é›†ç”»é¢ --- */
        #resultLayer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: #f0f4f8;
            color: #333;
            z-index: 50;
            display: none;
            flex-direction: column;
            overflow-y: auto;
            padding-bottom: 30px;
        }
        .result-header {
            padding: 15px;
            background: #fff;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex; justify-content: space-between; align-items: center;
        }
        .home-btn {
            background: #95a5a6; color: white; border: none;
            padding: 8px 15px; border-radius: 5px; font-weight: bold; cursor: pointer;
        }
        .result-content { padding: 20px; text-align: center; }
        .result-canvas { max-width: 100%; border: 1px solid #ccc; margin-bottom: 20px; }
        
        .slider-box { background: #fff; padding: 15px; border-radius: 10px; margin-top: 10px; }
        input[type=range] { width: 100%; margin: 15px 0; }
        .score-box { display: flex; justify-content: space-around; margin-top: 10px; }
        .main-score { font-size: 2rem; color: #27ae60; font-weight: bold; }
        .sub-score { font-size: 1rem; color: #7f8c8d; }

        /* GPSãƒœã‚¿ãƒ³ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .gps-section {
            margin-top: 20px;
            border-top: 1px dashed #ccc;
            padding-top: 15px;
        }
        .gps-btn {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .gps-btn:active { transform: scale(0.98); }
        .gps-result {
            margin-top: 10px;
            font-family: monospace;
            font-size: 1rem;
            color: #2c3e50;
            background: #ecf0f1;
            padding: 10px;
            border-radius: 5px;
            display: none; /* åˆæœŸã¯éè¡¨ç¤º */
        }

        /* ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠç”¨ï¼ˆéš ã—è¦ç´ ï¼‰ */
        #fileInput { display: none; }
    </style>
</head>
<body>

    <div id="startScreen">
        <div class="app-title">ğŸŒ² AIæ—å†  v2.2</div>
        
        <button class="mode-btn btn-camera" onclick="startCameraMode()">
            <span>ğŸ“·</span> ã‚«ãƒ¡ãƒ©ã§æ’®å½±
        </button>
        
        <button class="mode-btn btn-file" onclick="startFileMode()">
            <span>ğŸ“‚</span> å†™çœŸã‚’é¸æŠ
        </button>
        
        <div style="margin-top:20px; font-size:0.8rem; color:#7f8c8d;">
            â€»PCã‚„æ—¢å­˜ç”»åƒã¯ã€Œå†™çœŸã‚’é¸æŠã€ã¸
        </div>
    </div>
    
    <input type="file" id="fileInput" accept="image/*">


    <div class="camera-container" id="cameraContainer">
        <video id="video" autoplay playsinline muted></video>
        
        <button id="sensorBtn" class="sensor-btn" onclick="requestSensorPermission()">ğŸ“¡ æ°´æº–å™¨ON</button>

        <div class="level-overlay">
            <div class="crosshair"></div>
            <div class="target-circle" id="targetCircle"></div>
            <div class="bubble" id="bubble"></div>
        </div>
    </div>

    <div class="controls-area" id="controlsArea">
        <div class="back-btn" onclick="goHome()">ğŸ  æˆ»ã‚‹</div>
        <button class="shutter-btn" id="shutterBtn"></button>
    </div>


    <div id="resultLayer">
        <div class="result-header">
            <h2 style="margin:0; font-size:1.2rem;">ğŸŒ² è§£æçµæœ</h2>
            <button class="home-btn" onclick="goHome()">ğŸ  æœ€åˆã«æˆ»ã‚‹</button>
        </div>
        
        <div class="result-content">
            <canvas id="canvas" class="result-canvas"></canvas>
            
            <div class="slider-box">
                <label>ç©ºã®æ˜ã‚‹ã•èª¿æ•´</label>
                <input type="range" id="thresholdSlider" min="0" max="255" value="180">
                
                <div class="score-box">
                    <div>
                        <div>æ—å† è¢«è¦†ç‡</div>
                        <div class="main-score" id="treeRatio">-%</div>
                    </div>
                    <div>
                        <div>ç©ºéš™ç‡</div>
                        <div class="sub-score" id="skyRatio">-%</div>
                    </div>
                </div>
                <p style="font-size:0.8rem; color:red; margin-top:10px;">â€»èµ¤ã„éƒ¨åˆ†ã‚’ã€Œç©ºã€ã¨ã¿ãªã—ã¦ã„ã¾ã™</p>

                <div class="gps-section">
                    <button class="gps-btn" onclick="getLocation()">
                        ğŸ“ ç·¯åº¦çµŒåº¦ã‚’å–å¾—
                    </button>
                    <div id="gpsResult" class="gps-result"></div>
                </div>
            </div>
        </div>
    </div>


<script>
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
    }

    // --- UIè¦ç´  ---
    const startScreen = document.getElementById('startScreen');
    const cameraContainer = document.getElementById('cameraContainer');
    const controlsArea = document.getElementById('controlsArea');
    const resultLayer = document.getElementById('resultLayer');
    const fileInput = document.getElementById('fileInput');

    const video = document.getElementById('video');
    const bubble = document.getElementById('bubble');
    const targetCircle = document.getElementById('targetCircle');
    const sensorBtn = document.getElementById('sensorBtn');
    const shutterBtn = document.getElementById('shutterBtn');

    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    const slider = document.getElementById('thresholdSlider');
    const treeRatioDisplay = document.getElementById('treeRatio');
    const skyRatioDisplay = document.getElementById('skyRatio');

    // GPSè¡¨ç¤ºç”¨
    const gpsResult = document.getElementById('gpsResult');

    let originalImageData = null;
    let currentStream = null;
    let isCameraRunning = false;

    // --- ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ ---

    // 1. ã‚«ãƒ¡ãƒ©ãƒ¢ãƒ¼ãƒ‰é–‹å§‹
    async function startCameraMode() {
        startScreen.style.display = 'none';
        cameraContainer.style.display = 'flex';
        controlsArea.style.display = 'flex';
        
        try {
            // â˜…æ”¹è‰¯ç‚¹: ã‚¢ã‚¹ãƒšã‚¯ãƒˆæ¯”1ï¼ˆæ­£æ–¹å½¢ï¼‰ã‚’å„ªå…ˆçš„ã«è¦æ±‚
            const constraints = {
                video: {
                    facingMode: 'environment',
                    aspectRatio: 1, // æ­£æ–¹å½¢ã‚’è¦æ±‚
                    width: { ideal: 1920 },
                    height: { ideal: 1920 }
                },
                audio: false
            };
            currentStream = await navigator.mediaDevices.getUserMedia(constraints);
            video.srcObject = currentStream;
            isCameraRunning = true;
            
            // ã‚»ãƒ³ã‚µãƒ¼åˆæœŸåŒ–
            checkSensorPermission();
        } catch (err) {
            alert("ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã§ãã¾ã›ã‚“ã§ã—ãŸ");
            goHome();
        }
    }

    // 2. ãƒ•ã‚¡ã‚¤ãƒ«ãƒ¢ãƒ¼ãƒ‰é–‹å§‹
    function startFileMode() {
        fileInput.click();
    }

    // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã®å‡¦ç†
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
                startScreen.style.display = 'none';
                showResult(img);
            };
            img.src = event.target.result;
        };
        reader.readAsDataURL(file);
    });

    // 3. ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹ï¼ˆãƒªã‚»ãƒƒãƒˆï¼‰
    function goHome() {
        // ã‚«ãƒ¡ãƒ©åœæ­¢
        if (currentStream) {
            currentStream.getTracks().forEach(track => track.stop());
            currentStream = null;
        }
        isCameraRunning = false;

        // UIãƒªã‚»ãƒƒãƒˆ
        cameraContainer.style.display = 'none';
        controlsArea.style.display = 'none';
        resultLayer.style.display = 'none';
        startScreen.style.display = 'flex';
        
        // ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ›ãƒªã‚»ãƒƒãƒˆ
        fileInput.value = '';
        
        // GPSè¡¨ç¤ºãƒªã‚»ãƒƒãƒˆ
        gpsResult.style.display = 'none';
        gpsResult.textContent = '';
    }


    // --- æ°´æº–å™¨ãƒ­ã‚¸ãƒƒã‚¯ ---
    
    function checkSensorPermission() {
        if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
            sensorBtn.style.display = 'block';
        } else {
            window.addEventListener('deviceorientation', handleOrientation);
        }
    }

    function requestSensorPermission() {
        DeviceOrientationEvent.requestPermission().then(response => {
            if (response === 'granted') {
                sensorBtn.style.display = 'none';
                window.addEventListener('deviceorientation', handleOrientation);
            }
        });
    }

    function handleOrientation(event) {
        if (!isCameraRunning) return;

        let x = event.gamma; // å·¦å³
        let y = event.beta;  // å‰å¾Œ

        if (Math.abs(y) > 90) {
            if (y > 0) { y = 180 - y; } else { y = -180 - y; }
        }
        
        let moveX = x * 1.5;
        let moveY = y * 1.5;

        const maxDist = 80;
        const dist = Math.sqrt(moveX*moveX + moveY*moveY);
        if (dist > maxDist) {
            moveX = (moveX / dist) * maxDist;
            moveY = (moveY / dist) * maxDist;
        }

        bubble.style.transform = `translate(calc(-50% + ${moveX}px), calc(-50% + ${moveY}px))`;

        const threshold = 10;
        if (Math.abs(x) < threshold && Math.abs(y) < threshold) {
            targetCircle.classList.add('ok');
        } else {
            targetCircle.classList.remove('ok');
        }
    }


    // --- è§£æãƒ­ã‚¸ãƒƒã‚¯ ---

    // ã‚·ãƒ£ãƒƒã‚¿ãƒ¼ãƒœã‚¿ãƒ³
    shutterBtn.addEventListener('click', () => {
        // â˜…æ”¹è‰¯ç‚¹: ãƒ“ãƒ‡ã‚ªæ˜ åƒã‚’æ­£æ–¹å½¢ã«ã‚¯ãƒ­ãƒƒãƒ—ã—ã¦ã‚­ãƒ£ãƒ—ãƒãƒ£
        const w = video.videoWidth;
        const h = video.videoHeight;
        
        // çŸ­ã„æ–¹ã®è¾ºã«åˆã‚ã›ã¦æ­£æ–¹å½¢ã‚µã‚¤ã‚ºã‚’æ±ºå®š
        const size = Math.min(w, h);
        const startX = (w - size) / 2;
        const startY = (h - size) / 2;
        
        // ä½œæ¥­ç”¨ã‚­ãƒ£ãƒ³ãƒã‚¹ã§ç”»åƒåŒ–ï¼ˆæ­£æ–¹å½¢ï¼‰
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = size;
        tempCanvas.height = size;
        const tempCtx = tempCanvas.getContext('2d');
        
        // drawImage(image, sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight)
        tempCtx.drawImage(video, startX, startY, size, size, 0, 0, size, size);
        
        // Imageã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆåŒ–ã—ã¦å…±é€šå‡¦ç†ã¸
        const img = new Image();
        img.onload = () => showResult(img);
        img.src = tempCanvas.toDataURL('image/jpeg');
    });

    // è§£æã¨è¡¨ç¤ºï¼ˆå…±é€šé–¢æ•°ï¼‰
    function showResult(img) {
        resultLayer.style.display = 'flex';
        
        // ãƒªã‚µã‚¤ã‚ºè¨ˆç®—
        const MAX_SIZE = 800;
        let drawW = img.width;
        let drawH = img.height;
        if (drawW > drawH) {
            if (drawW > MAX_SIZE) { drawH = drawH * (MAX_SIZE/drawW); drawW = MAX_SIZE; }
        } else {
            if (drawH > MAX_SIZE) { drawW = drawW * (MAX_SIZE/drawH); drawH = MAX_SIZE; }
        }

        canvas.width = drawW;
        canvas.height = drawH;
        ctx.drawImage(img, 0, 0, drawW, drawH);
        
        originalImageData = ctx.getImageData(0, 0, drawW, drawH);
        
        // åˆæœŸè¨ˆç®—
        processImage();
    }

    slider.addEventListener('input', processImage);

    function processImage() {
        if (!originalImageData) return;

        const threshold = parseInt(slider.value);
        const w = canvas.width;
        const h = canvas.height;
        
        const src = originalImageData.data;
        const output = ctx.createImageData(w, h);
        const dst = output.data;

        let skyCount = 0;
        const totalPixels = w * h;

        for (let i = 0; i < src.length; i += 4) {
            const r = src[i];
            const g = src[i+1];
            const b = src[i+2];
            
            const lum = 0.299*r + 0.587*g + 0.114*b;

            if (lum > threshold) {
                skyCount++;
                dst[i] = 255; dst[i+1] = 0; dst[i+2] = 0; dst[i+3] = 255;
            } else {
                dst[i] = r; dst[i+1] = g; dst[i+2] = b; dst[i+3] = 255;
            }
        }
        
        ctx.putImageData(output, 0, 0);

        const skyRate = (skyCount / totalPixels) * 100;
        treeRatioDisplay.textContent = (100 - skyRate).toFixed(1) + '%';
        skyRatioDisplay.textContent = skyRate.toFixed(1) + '%';
    }

    // ç·¯åº¦çµŒåº¦å–å¾—å‡¦ç†
    function getLocation() {
        gpsResult.style.display = 'block';
        gpsResult.innerHTML = "ğŸ“¡ å–å¾—ä¸­...";

        if (!navigator.geolocation) {
            gpsResult.textContent = "ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“";
            return;
        }

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude.toFixed(6);
                const lng = position.coords.longitude.toFixed(6);
                gpsResult.innerHTML = `ç·¯åº¦: ${lat}<br>çµŒåº¦: ${lng}`;
            },
            (error) => {
                let errorMsg = "ä½ç½®æƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ";
                switch(error.code) {
                    case 1: errorMsg = "ä½ç½®æƒ…å ±ã®åˆ©ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“"; break;
                    case 2: errorMsg = "ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“"; break;
                    case 3: errorMsg = "ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ"; break;
                }
                gpsResult.textContent = errorMsg;
            },
            {
                enableHighAccuracy: true,
                timeout: 10000,
                maximumAge: 0
            }
        );
    }

</script>
</body>
</html>
